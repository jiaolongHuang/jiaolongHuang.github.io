<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 我遇到过的那些自动化脚本 · 小路口</title><meta name="description" content="我遇到过的那些自动化脚本 - jiaolongHuang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://jiaolongHuang.github.io/atom.xml" title="小路口"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/minel" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/jiaolonghuang" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">我遇到过的那些自动化脚本</h1><div class="post-info">Apr 17, 2016</div><div class="post-content"><p>在实际项目中，我们不可避免的需要用到自动化脚本来帮助我们完成一些事情，比如自动发送邮件，当系统宕机之后自动重启等等。<a id="more"></a>下面我将结合一个实际项目分析介绍，总共在哪些场景中使用了自动化脚本并且是如何做的。</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在这个项目中，我们除了完成构建系统的基本代码之外，还需要完成下面一些任务：</p>
<ol>
<li>定时进行数据处理并入库</li>
<li>定时使用casperjs截图，并发送邮件</li>
<li>监控是否有新代码提交，更新代码，并重启系统</li>
<li>为了保证顺利截图，还需要创建守护进程</li>
</ol>
<h2 id="crontab命令"><a href="#crontab命令" class="headerlink" title="crontab命令"></a>crontab命令</h2><ul>
<li>分析上面的一些任务，我们发现基本都有<strong>定时</strong>两个字，那么在linux中这个具体是怎么实现的呢。就是使用crontab命令来完成定时任务。(这里暂且先不做关于crontab具体介绍和使用的过多介绍,仅介绍在实际中是如何操作的)</li>
<li><code>crontab -e</code>编辑crontab列表；<code>crontab -l</code>查看crontab列表。</li>
<li>它执行任务的最小间隔是1min，利用这个特性，我们可以用来创建守护进程。即，如果发现某个进程不存在，即立即重新运行。</li>
<li>需要注意的是，crontab命令在执行时，往往并不知道这个命令是在什么样的环境下执行的。所以，对于执行命令，我们往往都写成命令的绝对路径，比如<code>/usr/local/bin/node</code></li>
<li><p>我们还可以在指定路径下，执行命令。比如:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">* * * * * (cd <span class="regexp">/sotraffic-web/</span>webpack; sh .<span class="regexp">/../</span>crontabscript<span class="regexp">/daemon.sh &gt;&gt; ./</span>..<span class="regexp">/log/</span>daemon.log)</div></pre></td></tr></table></figure>
</li>
<li><p>任意一个在命令行执行的命令都可以被创建成crontab定时任务。</p>
</li>
</ul>
<h2 id="选取脚本语言"><a href="#选取脚本语言" class="headerlink" title="选取脚本语言"></a>选取脚本语言</h2><ul>
<li><p>node<br>  这里隆重介绍下node中的<code>child_process = require(&#39;child_process&#39;)</code>模块，利用child_process中的<strong>exec</strong>方法，我们可以执行命令行中可执行的任意命令，比如：<code>cd path &amp;&amp; ls</code> 或者<code>git pull</code>，<code>pm2 restart</code>等等</p>
</li>
<li><p>shell, python<br>关于shell语法的介绍，可以参考<a href="http://hackerxu.com/2014/09/05/shell.html" target="_blank" rel="external">这个系列</a>。</p>
</li>
<li><p>针对前言提到的4个任务，我们都分别采用了什么脚本语言呢？</p>
</li>
</ul>
<ol>
<li>定时进行数据处理并入库 （node）</li>
<li><p>监控是否有新代码提交，更新代码，并重启系统 （node）</p>
</li>
<li><p>定时使用casperjs截图，并发送邮件 (casperjs, python, shell)<br>实际上这一步骤，是两个任务的结合，先用casperjs完成截图，并且截图完成后，再执行使用python编写的发送邮件脚本(实际上node也可以)。而结合的这一任务是用shell来写的。<br>在这一步骤中还遇到一个问题，就是由于未知原因，截图不能一次性成功。检测截图是否成功，如果不成功则继续执行命令，直到成功为止。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"====Starting capturing and sending Email===="</span></div><div class="line"><span class="built_in">echo</span> `date +%Y-%m-%d%t%H:%M:%S`</div><div class="line"></div><div class="line"><span class="built_in">source</span> /etc/bashrc</div><div class="line"></div><div class="line">TIME=`date +%Y-%m-%d`</div><div class="line">myFilePc=<span class="string">"/www/static/img/<span class="variable">$TIME</span>/report_pc.png"</span></div><div class="line">myFileMobile=<span class="string">"/www/static/img/<span class="variable">$TIME</span>/report_mobile.png"</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [ <span class="_">-f</span> <span class="variable">$myFilePc</span> ]</div><div class="line"><span class="keyword">then</span></div><div class="line">	rm <span class="_">-f</span> <span class="string">"<span class="variable">$myFilePc</span>"</span></div><div class="line">	<span class="built_in">echo</span> <span class="string">"rm <span class="variable">$myFilePc</span> is done!"</span></div><div class="line"><span class="keyword">else</span></div><div class="line">	<span class="built_in">echo</span> <span class="string">"cannot find <span class="variable">$myFilePc</span>"</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [ <span class="_">-f</span> <span class="variable">$myFileMobile</span> ]</div><div class="line"><span class="keyword">then</span></div><div class="line">	rm <span class="_">-f</span> <span class="string">"<span class="variable">$myFileMobile</span>"</span></div><div class="line">	<span class="built_in">echo</span> <span class="string">"rm <span class="variable">$myFileMobile</span> is done!"</span></div><div class="line"><span class="keyword">else</span></div><div class="line">	<span class="built_in">echo</span> <span class="string">"cannot find <span class="variable">$myFileMobile</span>"</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment">#需要检测哪个图没有截取成功，再次执行命令，所以把capture_pc和capture_mobile分成两个文件写，这样成本最低</span></div><div class="line"><span class="keyword">while</span> [ ! <span class="_">-f</span> <span class="variable">$myFilePc</span> ]</div><div class="line"><span class="keyword">do</span></div><div class="line">	/usr/<span class="built_in">local</span>/bin/casperjs /crontabscript/capture_pc.js</div><div class="line"><span class="keyword">done</span></div><div class="line"></div><div class="line"><span class="keyword">while</span> [ ! <span class="_">-f</span> <span class="variable">$myFileMobile</span> ]</div><div class="line"><span class="keyword">do</span></div><div class="line">	/usr/<span class="built_in">local</span>/bin/casperjs /crontabscript/capture_mobile.js</div><div class="line"><span class="keyword">done</span></div><div class="line"></div><div class="line">/usr/<span class="built_in">local</span>/Python-2.7.11/python /crontabscript/Email.py</div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">""</span></div></pre></td></tr></table></figure>
</li>
<li><p>为了保证顺利截图，还需要创建守护进程 (shell)<br>创建守护进行的思路是，每隔1分钟检查一次查找所需进程是否在进程列表中，如果没有，则启动进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">CONDITION=<span class="string">'能识别进程的关键字'</span></div><div class="line">CMD=<span class="string">'需要执行的命令'</span></div><div class="line"></div><div class="line">PROCESS_INFO=`ps aux|grep <span class="variable">$CONDITION</span>|grep -v <span class="string">'grep'</span>`</div><div class="line"><span class="comment">#echo $PROCESS_INFO</span></div><div class="line">PID=`<span class="built_in">echo</span> <span class="string">"<span class="variable">$PROCESS_INFO</span>"</span>|awk <span class="string">'&#123;print $2&#125;'</span>`</div><div class="line"><span class="comment">#echo $PID</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$PID</span>"</span> == <span class="string">""</span> ]</div><div class="line"><span class="keyword">then</span></div><div class="line">	TIME=`date`</div><div class="line">	<span class="built_in">echo</span> <span class="string">"=============<span class="variable">$TIME</span>==============="</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">'No runnning process found! Try starting new process...'</span></div><div class="line">    `<span class="variable">$CMD</span>`</div><div class="line">    <span class="built_in">echo</span> <span class="string">'Restart done!'</span></div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="记录日志"><a href="#记录日志" class="headerlink" title="记录日志"></a>记录日志</h2><p>因为这些脚本会定时自动执行，在执行过程中可能会失败，我们需要一些信息来帮助我们定位问题。所以一定要在脚本中输出一些有价值的信息，并记录日志。</p>
<h2 id="遇到过的问题"><a href="#遇到过的问题" class="headerlink" title="遇到过的问题"></a>遇到过的问题</h2><ul>
<li>python在发送邮件时，使用域名致使邮件不能成功发送，暂时使用IP。<strong>（原因待查）</strong></li>
<li>crontab执行截图时，报出phantomjs未安装，以及python未找到的错误。<br>  原因：crontab未找到正确的环境变量<br>  解决: 在脚本中执行截图操作前，先<code>source /etc/bashrc</code></li>
<li>重启webpack的命令需要在指定的路径下才能执行<br>  <img src="/img/webpack-error.png" alt=""><br>  解决：（1）先cd到指定路径，再执行命令。（2）或者命令中指定webpack.config.js  <figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>node <span class="regexp">/webpack/</span>node_modules<span class="regexp">/.bin/</span>webpack-dev-server <span class="regexp">/webpack/</span>webpack.config.js --inline --hot --quiet --host <span class="number">0.0</span>.<span class="number">0.0</span> --port <span class="number">8366</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h2><p>自我感想，无论是使用shell、python、node，或者php都是可以完成任务的，没有规定什么样的语言只能完成什么样的任务。个人更建议选择一种自己熟悉的语言，来完成所有操作，这样可以降低学习成本。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/04/19/mac-charles/" class="prev">PREV</a><a href="/2016/04/17/casperjs-example/" class="next">NEXT</a></div><div data-thread-key="2016/04/17/linux-js/" data-title="我遇到过的那些自动化脚本" data-url="http://jiaolongHuang.github.io/2016/04/17/linux-js/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"minel"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>友情链接：<a href="https://imququ.com" class="links-item">QuQu</a><a href="http://anjia.github.io" class="links-item">跑跑佳</a><a href="http://www.imwineki.cn/" class="links-item">Wineki</a><a href="http://westpsk.com/" class="links-item">ivan</a></p><p>© 2015 - 2016 <a href="http://jiaolongHuang.github.io">jiaolongHuang</a>. Love this theme <a href="https://github.com/pinggod/hexo-theme-apollo">apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>