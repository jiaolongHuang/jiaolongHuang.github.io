<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 常用Webpack2优化要点 · 小路口</title><meta name="description" content="常用Webpack2优化要点 - jiaolongHuang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://jiaolongHuang.github.io/atom.xml" title="小路口"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/minel" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/jiaolonghuang" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">常用Webpack2优化要点</h1><div class="post-info">Jul 26, 2017</div><div class="post-content"><p>基于webpack自身配置的优化，不涉及到happypack和DLL.</p>
<a id="more"></a>
<h2 id="总述"><a href="#总述" class="headerlink" title="总述"></a>总述</h2><p>webpack自身是单进程的。优化的总思路是，时间上，小范围，扫描次数少；空间上，能分离即分离，能不打包不打包，在http请求数与文件大小之间找到平衡。</p>
<h2 id="1-entry"><a href="#1-entry" class="headerlink" title="1.entry"></a>1.entry</h2><p>根据指定目录下动态生成entry对象，可根据不同场景区分entry中的数量。间接提高开发效率。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> srcDir = path.resolve(process.cwd(), <span class="string">'static/\$dev'</span>)</div><div class="line"><span class="keyword">let</span> componentsDir = path.resolve(process.cwd(), <span class="string">'static/\$dev/components'</span>)</div><div class="line"></div><div class="line"><span class="keyword">let</span> entries = <span class="function">(<span class="params">(</span>) =&gt;</span> &#123;</div><div class="line">	<span class="keyword">let</span> entryFiles = (process.env.NODE_ENV === <span class="string">'production'</span>)</div><div class="line">					? glob.sync(srcDir+<span class="string">"/+(index|service|tryout|app|user|stat|knowledge|doc|plan|tech|example|semservice|semutterance)/*.js"</span>)</div><div class="line">	 				: glob.sync(srcDir+<span class="string">"/+(index|semservice|semutterance|knowledge|app)/*.js"</span>)</div><div class="line">	<span class="keyword">let</span> map = &#123;&#125;</div><div class="line">	entryFiles.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">filepath</span>)</span>&#123;</div><div class="line">		<span class="keyword">let</span> filename = filepath.substring(filepath.lastIndexOf(<span class="string">'\/'</span>) + <span class="number">1</span>,filepath.lastIndexOf(<span class="string">"."</span>))</div><div class="line">		map[filename] = filepath;</div><div class="line">	&#125;);</div><div class="line">	<span class="keyword">return</span> map</div><div class="line">&#125;())</div></pre></td></tr></table></figure></p>
<h2 id="2-resolve"><a href="#2-resolve" class="headerlink" title="2.resolve"></a>2.resolve</h2><p><strong>modules</strong>默认只包括<strong>node_modules</strong>，如果需要添加其他的目录，需要保证<strong>node_modules</strong>在最后一位。<br><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">resolve:&#123;</div><div class="line">	<span class="comment">// 使用绝对路径，将只在给定目录中搜索。</span></div><div class="line">	modules: [path.resolve(<span class="number">__</span>dirname, <span class="string">"src"</span>), <span class="string">"node_modules"</span>],</div><div class="line">	<span class="comment">// 可省略文件后缀</span></div><div class="line">	extensions: [<span class="string">'.js'</span>, <span class="string">'.vue'</span>],</div><div class="line">	<span class="comment">// 减少webpack扫描时，每次查找相同包的时间。</span></div><div class="line">	<span class="keyword">alias</span>:&#123;</div><div class="line">		echarts:<span class="string">"components/echarts.min.js"</span>, <span class="comment">// echarts</span></div><div class="line">		citySelector:<span class="string">"components/citySelector.js"</span> <span class="comment">// 城市选择</span></div><div class="line">	&#125;</div><div class="line">&#125;,</div><div class="line"></div><div class="line"><span class="comment">// 文件内引用时</span></div><div class="line"><span class="keyword">import</span> echarts from <span class="string">'echarts'</span>;</div></pre></td></tr></table></figure></p>
<h2 id="3-module中的rules"><a href="#3-module中的rules" class="headerlink" title="3.module中的rules"></a>3.module中的rules</h2><p>总的来说就是，尽量添加<strong>include</strong>, <strong>exclude</strong>，限定范围。<br>在rules进行test时，尽量精准匹配，比如如果没有jsx的文件，只有js的，test就可以写为<strong>/.js$/</strong>，而不是<strong>/.jsx?$/</strong></p>
<p>其中babel, babel对文件的编译时间是比较久的，里面东西比较多，这里简单说几点。<br>配置中可以开启cache，这样在文件没有修改的时候，babel不会重新编译，以节约时间。<br>另一个是，<code>babel-pollyfill</code>和<code>transform-runtime</code>。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">	<span class="attribute">test</span>: /\.js$/,</div><div class="line">  loader: <span class="string">'babel-loader?cacheDirectory'</span>,</div><div class="line">  include: [path.<span class="built_in">resolve</span>(__dirname, <span class="string">"src"</span>)],</div><div class="line">  exclude: [path.<span class="built_in">resolve</span>(__dirname, <span class="string">"src"</span>, <span class="string">"assets"</span>), /node_modules/]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">.babelrc</div><div class="line">&#123;</div><div class="line">  <span class="string">"presets"</span>: [</div><div class="line">  	[</div><div class="line">  		<span class="string">"es2015"</span>,</div><div class="line">  	&#123;</div><div class="line">  		<span class="regexp">//</span> 对modules语法不做转换，defaults to <span class="string">'commonjs'</span></div><div class="line">  		<span class="string">"modules"</span>: <span class="keyword">false</span></div><div class="line">  	&#125;],</div><div class="line">  	<span class="regexp">//</span> <span class="number">0</span> -&gt; n, <span class="number">0</span>打包后的代码量最大。</div><div class="line">  	<span class="string">"stage-0"</span></div><div class="line">  ],</div><div class="line">  <span class="regexp">//</span> 动态对babel不能转换的新的API进行‘填补’</div><div class="line">  <span class="string">"plugins"</span>: [<span class="string">"transform-runtime"</span>],</div><div class="line">  <span class="string">"comments"</span>: <span class="keyword">false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-module中的noParse"><a href="#4-module中的noParse" class="headerlink" title="4.module中的noParse"></a>4.module中的noParse</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">module</span>&#123;</div><div class="line">	<span class="comment">//忽略的文件中不应该含有 import, require, define 的调用，或任何其他导入机制</span></div><div class="line">	<span class="comment">// noParse:[componentsDir]</span></div><div class="line">	<span class="attribute">noParse</span>:[<span class="string">'jquery'</span>, <span class="string">'lodash'</span>],</div><div class="line">	<span class="attribute">rules</span>: [</div><div class="line">		....</div><div class="line">	]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="5-只在production环境下的，tree-shaking"><a href="#5-只在production环境下的，tree-shaking" class="headerlink" title="5.只在production环境下的，tree-shaking"></a>5.只在production环境下的，tree-shaking</h2><p>实际验证现阶段（2017.7.27）tree-shaking之后，文件大小变化并不明显。主要受写法限制。尤其是引用大量第三方非ES6写法的库，其实作用不是很大。如果是从头自己写，在遵循ES6标准的基础上，控制性更好些。<br>同时uglify本身时间还比较长。用时间换空间的性价比不高。</p>
<p>因为tree-shaking必须配置一些压缩插件才能实现，默认是使用<strong>webpack-uglifyJS</strong>,但是由于是单进程的，处理比较慢。可选用<strong>webpack-parallel-uglify-plugin</strong>，多核处理。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">new UglifyJsparallelPlugin(&#123;</div><div class="line"><span class="attr">  cacheDir:</span> <span class="string">'.cache/'</span>,</div><div class="line"><span class="attr">  workerCount:</span> os.cpus().length,</div><div class="line"><span class="attr">  uglifyJS:</span> &#123;</div><div class="line">  	// 可以用uglifyJS自身的配置</div><div class="line">  	// 这里用于支持低版本IE</div><div class="line"><span class="attr">    supper_ie8:</span> <span class="literal">true</span>,</div><div class="line"><span class="attr">    compress:</span> &#123;</div><div class="line"><span class="attr">        screw_ie8:</span> <span class="literal">false</span>,</div><div class="line"><span class="attr">        properties:</span> <span class="literal">false</span>,</div><div class="line"><span class="attr">        warnings:</span> <span class="literal">false</span></div><div class="line">    &#125;,</div><div class="line"><span class="attr">    output:</span> &#123;</div><div class="line"><span class="attr">        screw_ie8:</span> <span class="literal">false</span>,</div><div class="line"><span class="attr">        beautify:</span> <span class="literal">true</span>,</div><div class="line"><span class="attr">        quote_keys:</span> <span class="literal">true</span></div><div class="line">    &#125;,</div><div class="line"><span class="attr">    mangle:</span> &#123;</div><div class="line"><span class="attr">        screw_ie8:</span> <span class="literal">false</span></div><div class="line">    &#125;,</div><div class="line"><span class="attr">    sourceMap:</span> <span class="literal">false</span></div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h2 id="6-只在dev环境下"><a href="#6-只在dev环境下" class="headerlink" title="6. 只在dev环境下"></a>6. 只在dev环境下</h2><p><code>module.exports.devtool = &#39;#cheap-module-eval-source-map&#39;;</code></p>
<h2 id="7-编译成es3"><a href="#7-编译成es3" class="headerlink" title="7. 编译成es3"></a>7. 编译成es3</h2><p>这里会遇到一些坑，另开一篇具体说说。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> es3ifyPlugin = <span class="built_in">require</span>(<span class="string">'es3ify-webpack-plugin'</span>);</div></pre></td></tr></table></figure></p>
<h2 id="好了，做完上述优化，你会发现时间上变化并不明显。。。其实最主要的还是需要DLL，拆分，分步。"><a href="#好了，做完上述优化，你会发现时间上变化并不明显。。。其实最主要的还是需要DLL，拆分，分步。" class="headerlink" title="好了，做完上述优化，你会发现时间上变化并不明显。。。其实最主要的还是需要DLL，拆分，分步。"></a>好了，做完上述优化，你会发现时间上变化并不明显。。。其实最主要的还是需要DLL，拆分，分步。</h2><h2 id="webpack-optimize-CommonsChunkPlugin"><a href="#webpack-optimize-CommonsChunkPlugin" class="headerlink" title="webpack.optimize.CommonsChunkPlugin"></a>webpack.optimize.CommonsChunkPlugin</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">entry中，</div><div class="line"><span class="comment">//需要配合下面的CommonsChunkPlugin才能把库文件从index中分类出来</span></div><div class="line"><span class="string">vendor:</span> [<span class="string">"vue"</span>, <span class="string">"vue-router"</span>, <span class="string">"axios"</span>]</div><div class="line"></div><div class="line"><span class="keyword">new</span> CommonsChunkPlugin(&#123;</div><div class="line"><span class="symbol">  name:</span> <span class="string">'vendor'</span>,</div><div class="line"><span class="symbol">  filename:</span> <span class="string">"vendor.js"</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h2 id="其他一些常用配置"><a href="#其他一些常用配置" class="headerlink" title="其他一些常用配置"></a>其他一些常用配置</h2><h3 id="pagejson"><a href="#pagejson" class="headerlink" title="pagejson"></a>pagejson</h3><p><strong>npm run build</strong><br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">"scripts":</span> <span class="comment">&#123;</span></div><div class="line">    <span class="comment">"dev":</span> <span class="comment">"webpack</span><span class="literal">-</span><span class="comment">dev</span><span class="literal">-</span><span class="comment">server</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">inline</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">hot</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">quiet</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">host</span> <span class="comment">127</span><span class="string">.</span><span class="comment">0</span><span class="string">.</span><span class="comment">0</span><span class="string">.</span><span class="comment">1</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">port</span> <span class="comment">8300"</span><span class="string">,</span></div><div class="line">    <span class="comment">"build":</span> <span class="comment">"</span><span class="string">.</span><span class="string">.</span><span class="comment">/node_modules/</span><span class="string">.</span><span class="comment">bin/cross</span><span class="literal">-</span><span class="comment">env</span> <span class="comment">NODE_ENV=production</span> <span class="comment">DEBUG_ENV=online</span> <span class="comment">webpack</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">progress</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">hide</span><span class="literal">-</span><span class="comment">modules</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">colors</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">profile"</span></div><div class="line">  <span class="comment">&#125;</span><span class="string">,</span></div></pre></td></tr></table></figure></p>
<h3 id="查看打包后的文件大小"><a href="#查看打包后的文件大小" class="headerlink" title="查看打包后的文件大小"></a>查看打包后的文件大小</h3><p><a href="http://alexkuz.github.io/webpack-chart/" target="_blank" rel="external">http://alexkuz.github.io/webpack-chart/</a><br>webpack –json –profile &gt; stats.json</p>
<h3 id="webpack-dev-server"><a href="#webpack-dev-server" class="headerlink" title="webpack-dev-server"></a>webpack-dev-server</h3><p>与webpack -w 的区别<br>webpack -w 增量打包，在界面不会有任何体现，需要手动刷新。</p>
<p>webpack-dev-server，基于express的8080 Node服务器。可以设置代理等等。<br>具有HMR(热替换), LiveReload(自动刷新整个页面)。<br>实时编译，在内存中的。比webpack -w更快。<br>打包的静态资源路径相对于publicPath，如果不设置，相对于当前目录下。</p>
<p><strong>这里面有个content-base, 还没弄清楚干啥的？？。。</strong></p>
</div></article></div></section><footer><div class="paginator"><a href="/2017/07/26/webpack-IE/" class="prev">上一篇</a><a href="/2016/09/11/range/" class="next">下一篇</a></div><div data-thread-key="2017/07/26/webpack2/" data-title="常用Webpack2优化要点" data-url="http://jiaolongHuang.github.io/2017/07/26/webpack2/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"minel"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>友情链接：<a href="https://imququ.com" class="links-item">QuQu</a><a href="http://anjia.github.io" class="links-item">跑跑佳</a><a href="http://www.imwineki.cn/" class="links-item">Wineki</a><a href="http://westpsk.com/" class="links-item">ivan</a></p><p>© 2015 - 2017 <a href="http://jiaolongHuang.github.io">jiaolongHuang</a>. Love this theme <a href="https://github.com/pinggod/hexo-theme-apollo">apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>